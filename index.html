<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>3A Console - ESP32 Sensor Device Status</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
      /* ========== VARIABLES ========== */
      :root {
        --primary-color: #3498db;
        --success-color: #2ecc71;
        --warning-color: #f39c12;
        --danger-color: #e74c3c;
        --info-color: #9b59b6;
      }

      /* ========== GENERAL STYLES ========== */
      body {
        padding-bottom: 2rem;
        background-color: #f8f9fa;
      }

      .navbar-brand {
        font-weight: bold;
        color: var(--primary-color) !important;
      }

      .last-update {
        font-size: 0.85rem;
        color: #6c757d;
        text-align: right;
        margin-top: 2rem;
      }

      /* ========== CARDS ========== */
      .card {
        border-radius: 0.5rem;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        transition: transform 0.2s;
        margin-bottom: 1.5rem;
      }

      .card:hover {
        transform: translateY(-5px);
      }

      .card-header {
        border-radius: 0.5rem 0.5rem 0 0 !important;
        font-weight: bold;
      }

      /* ========== STATUS INDICATORS ========== */
      .status-badge {
        font-size: 0.85rem;
        padding: 0.35rem 0.65rem;
        border-radius: 1rem;
      }


      /* Status colors - consistent across all elements */
      .up-to-date {
        background-color: var(--success-color);
        color: white;
      }

      .needs-update {
        background-color: var(--warning-color);
        color: white;
      }

      .patch-available {
        background-color: var(--info-color);
        color: white;
      }

      .unknown {
        background-color: var(--danger-color);
        color: white;
      }

      /* ========== COMPONENT TAGS ========== */
      .version-tag {
        background-color: var(--primary-color);
        color: white;
        border-radius: 0.25rem;
        padding: 0.2rem 0.5rem;
        font-size: 0.85rem;
        font-family: monospace;
      }

      .component-tag {
        background-color: #6c757d;
        color: white;
        border-radius: 0.25rem;
        padding: 0.1rem 0.4rem;
        font-size: 0.75rem;
        margin-right: 0.25rem;
        margin-bottom: 0.25rem;
        display: inline-block;
      }

      /* Component colors */
      .component-tag.modbus { background-color: #007bff; }
      .component-tag.onewire { background-color: #28a745; }
      .component-tag.digital { background-color: #6610f2; }
      .component-tag.analog { background-color: #fd7e14; }
      .component-tag.i2c { background-color: #20c997; }
      .component-tag.virtual { background-color: #9c27b0; }
      .component-tag.core { background-color: #343a40; }
      .component-tag.algae { background-color: #17a2b8; }
      .component-tag.switch { background-color: #ff6b35; }
      .component-tag.digital_switch { background-color: #ff6b35; }
      .component-tag.digital-switch { background-color: #ff6b35; } /* Support both formats */

      /* ========== SEARCH & FILTER ========== */
      .filter-section {
        background-color: white;
        padding: 1rem;
        border-radius: 0.5rem;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        margin-bottom: 1.5rem;
      }

      .filter-badge {
        cursor: pointer;
        margin-right: 0.5rem;
      }

      .component-filter {
        cursor: pointer;
        margin: 0.25rem;
      }

      /* ========== VERSION HISTORY ========== */
      .version-info {
        margin-top: 10px;
        font-size: 0.8rem;
        color: #6c757d;
        font-style: italic;
      }

      .version-changes {
        margin-top: 1rem;
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
      }

      .version-item {
        padding: 0.5rem 1rem;
        border-left: 3px solid var(--primary-color);
        margin-bottom: 0.5rem;
        background-color: rgba(52, 152, 219, 0.05);
        flex: 1 1 30%;
        min-width: 250px;
      }

      .version-title {
        font-weight: bold;
        color: var(--primary-color);
      }

      .version-date {
        font-size: 0.85rem;
        color: #6c757d;
        margin-left: 0.5rem;
      }

      .version-description {
        margin-top: 0.25rem;
        font-size: 0.9rem;
      }

      /* ========== DEVICE LIST VIEW ========== */
      .device-list-header {
        background-color: #f5f5f5;
        padding: 10px;
        border-radius: 5px 5px 0 0;
        font-weight: bold;
      }

      .device-list-item {
        color: #333; /* Default dark text color for all list items */
        padding: 10px;
        border-bottom: 1px solid #eee;
      }

      .device-list-item.needs-update {
        background-color: rgba(243, 156, 18, 0.15); /* Light orange background */
        border-left: 4px solid var(--warning-color);
      }

      .device-list-item.patch-available {
        background-color: rgba(155, 89, 182, 0.15); /* Light purple background */
        border-left: 4px solid var(--info-color);
      }

      .device-list-item.up-to-date {
        background-color: rgba(46, 204, 113, 0.15); /* Light green background */
        border-left: 4px solid var(--success-color);
      }

      /* Status column text should be dark but colored */
      .device-list-item.needs-update .col-md-2:nth-child(3) {
        color: #c87000; /* Dark orange */
        font-weight: bold;
      }

      .device-list-item.patch-available .col-md-2:nth-child(3) {
        color: #6a1b9a; /* Dark purple */
        font-weight: bold;
      }

      .device-list-item.up-to-date .col-md-2:nth-child(3) {
        color: #1b5e20; /* Dark green */
        font-weight: bold;
      }

      /* Hover effects for list items - slightly darker but still light backgrounds */
      .device-list-item.needs-update:hover {
        background-color: rgba(243, 156, 18, 0.25);
        transition: background-color 0.2s ease;
      }

      .device-list-item.patch-available:hover {
        background-color: rgba(155, 89, 182, 0.25);
        transition: background-color 0.2s ease;
      }

      .device-list-item.up-to-date:hover {
        background-color: rgba(46, 204, 113, 0.25);
        transition: background-color 0.2s ease;
      }

      /* List status text styling */
      .device-list-item .col-md-2:nth-child(3) {
        font-weight: bold;
      }

      .device-list-item.needs-update .col-md-2:nth-child(3) {
        color: var(--warning-color);
      }

      .device-list-item.patch-available .col-md-2:nth-child(3) {
        color: var(--info-color);
      }

      .device-list-item.up-to-date .col-md-2:nth-child(3) {
        color: var(--success-color);
      }

      /* ========== SORTING CONTROLS ========== */
      .sorting-controls {
        margin: 20px 0;
      }

      .sort-btn.active {
        background-color: #0d6efd;
        color: white;
      }

      /* View toggle buttons */
      .view-toggle {
        margin-bottom: 1rem;
      }

    </style>
  </head>
  <body>
    <nav class="navbar navbar-expand-lg navbar-light bg-white mb-4 shadow-sm">
      <div class="container">
        <a class="navbar-brand" href="#">
          <i class="bi bi-cpu"></i> 3A Console - ESP32 Sensor Status
        </a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
          <ul class="navbar-nav ms-auto">
            <li class="nav-item">
              <a class="nav-link" href="#overview"><i class="bi bi-house"></i> Overview</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="#devices"><i class="bi bi-grid"></i> Devices</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="#versions"><i class="bi bi-list-check"></i> Version Timeline</a>
            </li>
          </ul>
        </div>
      </div>
    </nav>

    <div class="container" id="overview">
      <!-- Overview Cards -->
      <div class="row mb-4">
        <div class="col-md-6">
          <div class="card">
            <div class="card-header bg-primary text-white">
              <i class="bi bi-info-circle"></i> Template Information
            </div>
            <div class="card-body">
              <h5 class="card-title">
                Latest Version:
                <span id="latest-version" class="version-tag"></span>
              </h5>
              <p class="card-text">
                <i class="bi bi-github"></i> Repository:
                <span id="repo-name"></span>
              </p>
              <p class="card-text">
                <i class="bi bi-clock"></i> Last commit:
                <span id="last-commit-date"></span>
              </p>
            </div>
          </div>
        </div>
        <div class="col-md-6">
          <div class="card">
            <div class="card-header bg-info text-white">
              <i class="bi bi-pie-chart"></i> Status Overview
            </div>
            <div class="card-body">
              <div style="height: 250px; width: 250px; margin: 0 auto;">
                <canvas id="status-chart"></canvas>
              </div>
            </div>
          </div>
        </div>
      </div>


      <!-- Device Status Section -->
      <section id="devices">
        <h2 class="mb-3"><i class="bi bi-grid"></i> Device Status</h2>

        <!-- Filters -->
        <div class="filter-section mb-4">
          <div class="row align-items-center mb-3">
            <div class="col-md-8">
              <div class="input-group">
                <span class="input-group-text"><i class="bi bi-search"></i></span>
                <input type="text" id="device-search" class="form-control" placeholder="Search devices..." />
              </div>
            </div>
            <div class="col-md-4">
              <div class="d-flex justify-content-end">
                <span class="filter-badge badge bg-success" data-filter="up-to-date">Up to date</span>
                <span class="filter-badge badge" style="background-color: var(--info-color); color: white" data-filter="patch-available">Patch available</span>
                <span class="filter-badge badge bg-warning text-dark" data-filter="needs-update">Needs update</span>
                <span class="filter-badge badge bg-danger" data-filter="unknown">Unknown</span>
              </div>
            </div>
          </div>

          <div class="row">
            <div class="col-12">
              <p class="mb-1"><small>Filter by component:</small></p>
              <div id="component-filters">
                <!-- Component filters will be added here -->
              </div>
            </div>
          </div>
        </div>

        <!-- View Toggle Buttons -->
        <div class="view-toggle btn-group mb-3" role="group">
          <button id="card-view-btn" class="btn btn-sm btn-outline-primary active">Card View</button>
          <button id="list-view-btn" class="btn btn-sm btn-outline-primary">List View</button>
        </div>

        <!-- Device Sorting Controls -->
        <div class="sorting-controls mb-3">
          <label>Sort devices by: </label>
          <div class="btn-group" role="group">
            <button id="sort-by-date" class="btn btn-sm btn-outline-primary sort-btn active">Date Updated</button>
            <button id="sort-by-name" class="btn btn-sm btn-outline-primary sort-btn">Name</button>
            <button id="sort-by-status" class="btn btn-sm btn-outline-primary sort-btn">Status</button>
            <button id="sort-by-location" class="btn btn-sm btn-outline-primary sort-btn">Location</button>
          </div>
        </div>

        <!-- Device List Container -->
        <div id="device-list" class="mb-5" style="display: none"></div>

        <!-- Device Cards Container -->
        <div class="row" id="device-cards">
          <!-- Device cards will be populated here -->
          <div class="col-12 text-center py-5">
            <div class="spinner-border text-primary" role="status">
              <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-2">Loading device data...</p>
          </div>
        </div>
      </section>

      <!-- Version Timeline Section -->
      <section id="versions" class="mb-5">
        <h2 class="mb-3"><i class="bi bi-list-check"></i> Version Timeline</h2>
        <div class="card">
          <div class="card-body">
            <div class="version-changes" id="version-changes-list">
              <!-- Version changes will be populated here -->
              <div class="text-center py-2">
                <div class="spinner-border text-primary" role="status">
                  <span class="visually-hidden">Loading...</span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </section>


      <p class="last-update">
        Dashboard updated: <span id="last-updated"></span>
      </p>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      // Main initialization
      document.addEventListener("DOMContentLoaded", () => {
        initDashboard();
      });

      /**
       * Initialize the dashboard by loading data and creating components
       */
      async function initDashboard() {
        try {
          // Fetch device status data
          const response = await fetch("data/device-status.json");
          if (!response.ok) {
            throw new Error(`HTTP error! Status: ${response.status}`);
          }
          const dashboardData = await response.json();

          // Update header information
          document.getElementById("latest-version").textContent = dashboardData.latest_version;
          document.getElementById("repo-name").textContent = dashboardData.repo_name;
          document.getElementById("last-commit-date").textContent = dashboardData.last_commit_date;
          document.getElementById("last-updated").textContent = formatDate(dashboardData.last_updated);

          // Process devices and count statuses for chart
          let statusCounts = {
            "Up to date": 0,
            "Patch available": 0,
            "Needs update": 0,
            "Unknown": 0,
          };

          dashboardData.devices.forEach((device) => {
            // Calculate status
            const calculatedStatus = getUpdateStatus(
              device.version,
              dashboardData.latest_version,
              device.components,
              device.updateReason
            );

            // Count statuses for chart
            statusCounts[calculatedStatus]++;

            // Add calculated status to device
            device.calculatedStatus = calculatedStatus;
          });

          // Initialize all dashboard components
          createVersionHistory(dashboardData.version_changes);
          createComponentFilters(dashboardData.devices);
          renderDeviceList(dashboardData.devices, "date");
          createDeviceCards(dashboardData.devices, dashboardData.latest_version);
          

          createStatusChart(statusCounts);
          setupEventListeners(dashboardData);
        } catch (error) {
          console.error("Error initializing dashboard:", error);
          document.getElementById("device-cards").innerHTML = `
            <div class="col-12 text-center py-5">
              <div class="alert alert-warning">
                <h4><i class="bi bi-exclamation-triangle"></i> Error Loading Data</h4>
                <p>Unable to load device-status.json: ${error.message}</p>
                <p>If running locally, please use a web server:</p>
                <ul class="text-start">
                  <li>Python: <code>python -m http.server</code></li>
                  <li>Node.js: <code>npx http-server</code></li>
                </ul>
              </div>
            </div>
          `;
        }
      }

      /**
       * Format a date string for display
       */
      function formatDate(dateStr) {
        if (!dateStr || dateStr === "Never" || dateStr === "N/A") return dateStr;
        const date = new Date(dateStr);
        return date.toLocaleDateString() + " " + date.toLocaleTimeString();
      }

      /**
       * Parse date string which can be in dd-mm-yyyy or yyyy-mm-dd format
       */
      function parseDateString(dateStr) {
        if (!dateStr || dateStr === "Never") return "Never";
        
        // Check if it's in dd-mm-yyyy format (new format from script)
        if (dateStr.match(/^\d{2}-\d{2}-\d{4}$/)) {
          return dateStr; // Already formatted for display
        }
        
        // Otherwise assume it's a standard date format and convert to dd-mm-yyyy
        const date = new Date(dateStr);
        if (isNaN(date.getTime())) return dateStr; // Invalid date, return as-is
        
        const day = String(date.getDate()).padStart(2, '0');
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const year = date.getFullYear();
        return `${day}-${month}-${year}`;
      }

      /**
       * Parse date string for sorting purposes
       */
      function parseDateForSort(dateStr) {
        if (!dateStr || dateStr === "Never") return new Date(0); // Very old date for sorting
        
        // Check if it's in dd-mm-yyyy format
        if (dateStr.match(/^\d{2}-\d{2}-\d{4}$/)) {
          const [day, month, year] = dateStr.split('-');
          return new Date(year, month - 1, day);
        }
        
        // Otherwise parse as standard date format
        return new Date(dateStr);
      }

      /**
       * Determine if a device needs an update based on semantic versioning
       */
      function getUpdateStatus(deviceVersion, latestVersion, deviceComponents, updateReason) {
        // If no device version is available, it needs an update
        if (!deviceVersion) return "Unknown";

        // Parse version strings (assuming format vX.Y.Z)
        const parseVersion = (version) => {
          const match = version.match(/v?(\d+)\.(\d+)\.(\d+)/);
          if (!match) return null;
          return {
            major: parseInt(match[1], 10),
            minor: parseInt(match[2], 10),
            patch: parseInt(match[3], 10),
          };
        };

        const deviceVer = parseVersion(deviceVersion);
        const latestVer = parseVersion(latestVersion);

        // If parsing failed, conservatively assume update is needed
        if (!deviceVer || !latestVer) return "Unknown";

        // Check version differences
        if (deviceVer.major < latestVer.major) {
          return "Needs update"; // Major version behind - critical update
        } else if (
          deviceVer.major === latestVer.major &&
          deviceVer.minor < latestVer.minor
        ) {
          return "Needs update"; // Minor version behind - important functionality
        } else if (
          deviceVer.major === latestVer.major &&
          deviceVer.minor === latestVer.minor &&
          deviceVer.patch < latestVer.patch
        ) {
          return "Patch available"; // Patch-level update available
        } else {
          return "Up to date"; // Completely up to date
        }
      }

      /**
       * Generate HTML for component tags
       */
      function generateComponentTags(components) {
        if (!components || !Array.isArray(components) || components.length === 0) {
          return '<span class="text-muted">None specified</span>';
        }

        return components
          .map(component => `<span class="component-tag ${component.toLowerCase()}">${component}</span>`)
          .join("");
      }

      /**
       * Create the version history section
       */
      function createVersionHistory(versionChanges) {
        if (!versionChanges || !Array.isArray(versionChanges)) return;

        const container = document.getElementById("version-changes-list");
        container.innerHTML = "";

        // Only show the most recent 9 versions to keep it compact
        const recentChanges = versionChanges.slice(0, 9);

        recentChanges.forEach((version) => {
          const versionItem = document.createElement("div");
          versionItem.className = "version-item";

          versionItem.innerHTML = `
            <div>
              <span class="version-title">${version.version}</span>
              <span class="version-date">${version.date}</span>
            </div>
            <div class="version-components my-1">
              ${generateComponentTags(version.components)}
            </div>
            <div class="version-description">
              ${version.description}
            </div>
          `;

          container.appendChild(versionItem);
        });

        // Add a "Show more" button if there are more versions
        if (versionChanges.length > 9) {
          const showMoreBtn = document.createElement("button");
          showMoreBtn.className = "btn btn-sm btn-outline-primary mt-2";
          showMoreBtn.textContent = `Show ${versionChanges.length - 9} more versions`;
          showMoreBtn.onclick = function () {
            createFullVersionHistory(versionChanges);
            this.style.display = "none";
          };

          container.appendChild(showMoreBtn);
        }

        if (versionChanges.length === 0) {
          container.innerHTML = '<div class="text-center py-3">No version history available</div>';
        }
      }

      /**
       * Show all version history when "Show more" is clicked
       */
      function createFullVersionHistory(versionChanges) {
        const container = document.getElementById("version-changes-list");
        const showMoreBtn = container.querySelector("button");

        if (showMoreBtn) {
          container.removeChild(showMoreBtn);
        }

        // Add the remaining versions
        for (let i = 9; i < versionChanges.length; i++) {
          const version = versionChanges[i];
          const versionItem = document.createElement("div");
          versionItem.className = "version-item";

          versionItem.innerHTML = `
            <div>
              <span class="version-title">${version.version}</span>
              <span class="version-date">${version.date}</span>
            </div>
            <div class="version-components my-1">
              ${generateComponentTags(version.components)}
            </div>
            <div class="version-description">
              ${version.description}
            </div>
          `;

          container.appendChild(versionItem);
        }
      }

      /**
       * Create component filter badges
       */
      function createComponentFilters(devices) {
        const componentsSet = new Set();

        // Collect all unique components
        devices.forEach((device) => {
          if (device.components && Array.isArray(device.components)) {
            device.components.forEach((comp) => componentsSet.add(comp));
          }
        });

        // Create filter badges
        const filterContainer = document.getElementById("component-filters");
        filterContainer.innerHTML = "";

        const componentsList = Array.from(componentsSet).sort();
        componentsList.forEach((comp) => {
          const badge = document.createElement("span");
          badge.className = `component-filter component-tag ${comp.toLowerCase()}`;
          badge.textContent = comp;
          badge.dataset.component = comp.toLowerCase();

          badge.addEventListener("click", function () {
            const isActive = this.classList.contains("active");

            // Reset all filters
            document.querySelectorAll(".component-filter").forEach((b) => {
              b.classList.remove("active");
              b.style.opacity = "1";
            });

            if (!isActive) {
              // Activate this filter
              this.classList.add("active");

              // Dim other filters
              document.querySelectorAll(".component-filter:not(.active)").forEach((b) => {
                b.style.opacity = "0.5";
              });

              // Filter devices
              filterDevicesByComponent(comp.toLowerCase());
            } else {
              // Show all devices
              showAllDevices();
            }
          });

          filterContainer.appendChild(badge);
        });

        if (componentsList.length === 0) {
          filterContainer.innerHTML = '<div class="text-muted">No components defined</div>';
        }
      }

      /**
       * Sort devices array by specified criteria
       */
      function sortDevices(devices, sortBy = "date") {
        // Sort functions for different sort types
        const sortFunctions = {
          // Sort by deployment date (newest first)
          date: (a, b) => {
            if (!a.last_deployed || a.last_deployed === "Never") return 1;
            if (!b.last_deployed || b.last_deployed === "Never") return -1;
            return parseDateForSort(b.last_deployed) - parseDateForSort(a.last_deployed);
          },
          // Sort by name (alphabetical)
          name: (a, b) => a.name.localeCompare(b.name),
          // Sort by status (priority order)
          status: (a, b) => {
            const statusPriority = {
              "Needs update": 0,
              "Patch available": 1,
              "Up to date": 2,
              "Never deployed": 3,
              "Unknown": 4,
            };
            const statusA = a.calculatedStatus || a.status;
            const statusB = b.calculatedStatus || b.status;
            return statusPriority[statusA] - statusPriority[statusB];
          },
          // Sort by location
          location: (a, b) => {
            if (!a.location) return 1;
            if (!b.location) return -1;
            return a.location.localeCompare(b.location);
          },
        };

        return [...devices].sort(sortFunctions[sortBy]);
      }

      /**
       * Render the device list with sorting
       */
      function renderDeviceList(devices, sortBy = "date") {
        const container = document.getElementById("device-list");
        if (!container) return;

        // Sort the devices
        const sortedDevices = sortDevices(devices, sortBy);

        // Clear the container
        container.innerHTML = "";

        // Add header row
        const headerRow = document.createElement("div");
        headerRow.className = "device-list-header row";
        headerRow.innerHTML = `
          <div class="col-md-3 fw-bold">Device Name</div>
          <div class="col-md-2 fw-bold">Version</div>
          <div class="col-md-2 fw-bold">Status</div>
          <div class="col-md-3 fw-bold">Location</div>
          <div class="col-md-2 fw-bold">Last Updated</div>
        `;
        container.appendChild(headerRow);

        // Add device rows
        sortedDevices.forEach((device) => {
          const row = document.createElement("div");
          row.className = "device-list-item row";

          // Calculate status if not already set
          const status = device.calculatedStatus || device.status || "Unknown";

          // Add status-based class
          if (status === "Needs update") {
            row.classList.add("needs-update");
          } else if (status === "Patch available") {
            row.classList.add("patch-available");
          } else if (status === "Up to date") {
            row.classList.add("up-to-date");
          }

          const date = device.last_deployed ? parseDateString(device.last_deployed) : "Never";

          row.innerHTML = `
            <div class="col-md-3">${device.name}</div>
            <div class="col-md-2">${device.version || device.template_version || "-"}</div>
            <div class="col-md-2">${status}</div>
            <div class="col-md-3">${device.location || "-"}</div>
            <div class="col-md-2">${date}</div>
          `;

          container.appendChild(row);
        });

        // Update active sort button
        document.querySelectorAll(".sort-btn").forEach((btn) => {
          btn.classList.remove("active");
        });
        document.getElementById(`sort-by-${sortBy}`).classList.add("active");
      }

      /**
       * Create device cards
       */
      function createDeviceCards(devices, latestVersion) {
        const deviceCardsContainer = document.getElementById("device-cards");
        deviceCardsContainer.innerHTML = ""; // Clear loading spinner

        // Create device cards
        devices.forEach((device) => {
          // Get status (either from calculated status or from device.status)
          const status = device.calculatedStatus || device.status || "Unknown";

          // Create card
          const col = document.createElement("div");
          col.className = "col-md-6 col-lg-4 device-item";
          col.dataset.status = status.replace(/\s+/g, "-").toLowerCase();

          // Add component data attributes for filtering
          if (device.components && Array.isArray(device.components)) {
            device.components.forEach((comp) => {
              col.dataset[comp.toLowerCase()] = "true";
            });
          }

          let statusClass = "";
          if (status === "Up to date") statusClass = "up-to-date";
          else if (status === "Patch available") statusClass = "patch-available";
          else if (status === "Needs update") statusClass = "needs-update";
          else statusClass = "unknown";

          let cardHtml = `
            <div class="card">
              <div class="card-header bg-light">
                <div class="d-flex justify-content-between align-items-center">
                  <span>${device.name}</span>
                  <span class="status-badge ${statusClass}">${status}</span>
                </div>
              </div>
              <div class="card-body">
                <div class="mb-3">
                  <small class="text-muted">Template Version:</small>
                  <div><span class="version-tag">${device.template_version || device.version || "Unknown"}</span></div>
                </div>
                <div class="mb-3">
                  <small class="text-muted">Components:</small>
                  <div>${generateComponentTags(device.components)}</div>
                </div>`;


          cardHtml += `
                <div class="mb-3">
                  <small class="text-muted">Location:</small>
                  <div>${device.location || "Unknown"}</div>
                </div>
                <div class="mb-2">
                  <small class="text-muted">Last Deployed:</small>
                  <div><strong>${device.last_deployed || "Never"}</strong></div>
                </div>
                <div>
                  <small class="text-muted">Initial Deployment:</small>
                  <div><strong>${device.initial_deployed || "Never"}</strong></div>
                </div>
              </div>
            </div>
          `;

          col.innerHTML = cardHtml;
          deviceCardsContainer.appendChild(col);
        });
      }

      /**
       * Create the status chart
       */
      function createStatusChart(statusCounts) {
        const ctx = document.getElementById("status-chart").getContext("2d");
        new Chart(ctx, {
          type: "doughnut",
          data: {
            labels: Object.keys(statusCounts),
            datasets: [
              {
                data: Object.values(statusCounts),
                backgroundColor: [
                  "rgba(46, 204, 113, 0.8)", // Up to date - green
                  "rgba(155, 89, 182, 0.8)", // Patch available - purple
                  "rgba(243, 156, 18, 0.8)", // Needs update - orange
                  "rgba(231, 76, 60, 0.8)", // Unknown - red
                ],
                borderColor: [
                  "rgba(46, 204, 113, 1)",
                  "rgba(155, 89, 182, 1)",
                  "rgba(243, 156, 18, 1)",
                  "rgba(231, 76, 60, 1)",
                ],
                borderWidth: 1,
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                position: "bottom",
                labels: {
                  fontSize: 12,
                  padding: 10
                }
              },
            },
          },
        });
      }


      /**
       * Reset filter badges to their original state
       */
      function resetFilterBadges(greyOut = false) {
        const filterBadges = document.querySelectorAll(".filter-badge");
        filterBadges.forEach((b) => {
          b.className = "filter-badge badge";
          if (greyOut) {
            b.classList.add("bg-secondary");
          } else {
            const filterClass = b.dataset.filter;
            if (filterClass === "up-to-date") {
              b.classList.add("bg-success");
            } else if (filterClass === "patch-available") {
              b.classList.add("bg-info");
            } else if (filterClass === "needs-update") {
              b.classList.add("bg-warning", "text-dark");
            } else if (filterClass === "unknown") {
              b.classList.add("bg-danger");
            }

            // Show all devices
            showAllDevices();
          }
        });
      }

      /**
       * Show all devices in both card and list views
       */
      function showAllDevices() {
        // Show all devices in card view
        document.querySelectorAll(".device-item").forEach((item) => {
          item.style.display = "block";
        });
        
        // Show all devices in list view
        document.querySelectorAll(".device-list-item").forEach((item) => {
          item.style.display = "";
        });
      }

      /**
       * Filter devices by status class
       */
      function filterDevicesByStatus(statusClass) {
        // Filter card view
        document.querySelectorAll(".device-item").forEach((item) => {
          item.style.display = item.dataset.status === statusClass ? "block" : "none";
        });

        // Filter list view
        document.querySelectorAll(".device-list-item").forEach((item) => {
          item.style.display = item.classList.contains(statusClass) ? "" : "none";
        });
      }

      /**
       * Filter devices by component
       */
      function filterDevicesByComponent(component) {
        // Filter card view
        const deviceItems = document.querySelectorAll(".device-item");
        deviceItems.forEach((item) => {
          item.style.display = item.dataset[component] ? "block" : "none";
        });

        // Filter list view
        document.querySelectorAll(".device-list-item").forEach((item) => {
          const deviceName = item.querySelector(".col-md-3").textContent;
          const matchingCard = Array.from(deviceItems).find((card) =>
            card.querySelector(".card-header").textContent.includes(deviceName)
          );

          item.style.display = (matchingCard && matchingCard.dataset[component]) ? "" : "none";
        });
      }

      /**
       * Filter devices based on search term
       */
      function filterDevices() {
        const searchTerm = document.getElementById("device-search").value.toLowerCase();

        // Filter card view
        document.querySelectorAll(".device-item").forEach((item) => {
          const deviceText = item.textContent.toLowerCase();
          item.style.display = deviceText.includes(searchTerm) ? "block" : "none";
        });

        // Filter list view
        document.querySelectorAll(".device-list-item").forEach((item) => {
          const text = item.textContent.toLowerCase();
          item.style.display = text.includes(searchTerm) ? "" : "none";
        });
      }

      /**
       * Set up all event listeners
       */
      function setupEventListeners(data) {
        // Set up search functionality
        document.getElementById("device-search").addEventListener("input", filterDevices);

        // Set up filter badges
        document.querySelectorAll(".filter-badge").forEach((badge) => {
          badge.addEventListener("click", () => {
            if (badge.classList.contains("bg-secondary")) {
              // Reset the badge to its original color
              resetFilterBadges();
            } else {
              // Set all badges to secondary color first
              resetFilterBadges(true);

              // Restore this badge to its original color
              const filterClass = badge.dataset.filter;
              if (filterClass === "up-to-date") {
                badge.classList.remove("bg-secondary");
                badge.classList.add("bg-success");
              } else if (filterClass === "patch-available") {
                badge.classList.remove("bg-secondary");
                badge.classList.add("bg-info");
              } else if (filterClass === "needs-update") {
                badge.classList.remove("bg-secondary");
                badge.classList.add("bg-warning", "text-dark");
              } else if (filterClass === "unknown") {
                badge.classList.remove("bg-secondary");
                badge.classList.add("bg-danger");
              }

              // Filter the devices
              filterDevicesByStatus(filterClass);
            }
          });
        });

        // Set up view toggle buttons
        document.getElementById("card-view-btn").addEventListener("click", () => {
          document.getElementById("device-cards").style.display = "flex";
          document.getElementById("device-list").style.display = "none";
          document.getElementById("card-view-btn").classList.add("active");
          document.getElementById("list-view-btn").classList.remove("active");
        });

        document.getElementById("list-view-btn").addEventListener("click", () => {
          document.getElementById("device-cards").style.display = "none";
          document.getElementById("device-list").style.display = "block";
          document.getElementById("card-view-btn").classList.remove("active");
          document.getElementById("list-view-btn").classList.add("active");
        });

        // Set up sort buttons
        document.getElementById("sort-by-date").addEventListener("click", () => {
          renderDeviceList(data.devices, "date");
          createDeviceCards(sortDevices(data.devices, "date"), data.latest_version);
        });

        document.getElementById("sort-by-name").addEventListener("click", () => {
          renderDeviceList(data.devices, "name");
          createDeviceCards(sortDevices(data.devices, "name"), data.latest_version);
        });

        document.getElementById("sort-by-status").addEventListener("click", () => {
          renderDeviceList(data.devices, "status");
          createDeviceCards(sortDevices(data.devices, "status"), data.latest_version);
        });

        document.getElementById("sort-by-location").addEventListener("click", () => {
          renderDeviceList(data.devices, "location");
          createDeviceCards(sortDevices(data.devices, "location"), data.latest_version);
        });
      }
    </script>
  </body>
</html>